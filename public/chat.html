<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat & Share</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-start: #F1F5F9;
            --background-end: #E2E8F0;
            --surface-color: #FFFFFF;
            --primary-color: #4F46E5;
            --primary-hover: #4338CA;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --border-color: #CBD5E1;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #DC2626;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevents main page scroll */
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background: var(--background-start);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: var(--surface-color);
        }

        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .main-header h1 { font-size: 1.25rem; font-weight: 600; }
        .back-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; }
        .back-btn:hover { background-color: #F8FAFC; border-color: #94A3B8; }

        .main-content { display: flex; flex-grow: 1; overflow: hidden; /* Critical for layout */ }
        .chat-wrapper { flex: 3; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .chat-iframe { flex-grow: 1; border: none; }
        .video-wrapper { flex: 2; display: flex; flex-direction: column; padding: 24px; overflow-y: auto; background-color: #F8FAFC; }

        .upload-area { background: var(--surface-color); border: 2px dashed var(--border-color); border-radius: 12px; padding: 32px; text-align: center; margin-bottom: 24px; transition: all 0.2s ease; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-color); background-color: #F1F5F9; }
        .upload-area h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
        .upload-area p { font-size: 0.9rem; color: var(--text-secondary); }
        .file-input { display: none; }
        .btn { background-color: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s ease; }
        .btn:hover { background-color: var(--primary-hover); }
        .btn:disabled { background-color: #94A3B8; cursor: not-allowed; }

        .video-display { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .video-item { background: var(--surface-color); border-radius: 12px; box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -2px var(--shadow-color); overflow: hidden; transition: all 0.2s ease; position: relative; }
        .video-item:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color); }
        .video-item video { width: 100%; display: block; background-color: #000; }
        .video-info { padding: 12px; }
        .video-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .video-time { font-size: 0.8rem; color: var(--text-secondary); }
        .delete-video-btn { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 16px; line-height: 28px; text-align: center; cursor: pointer; opacity: 0; transition: opacity 0.2s ease; }
        .video-item:hover .delete-video-btn { opacity: 1; }

        .mobile-nav { display: none; }

        @media (max-width: 768px) {
            body { padding: 0; }
            .app-container { border-radius: 0; }
            .main-header { padding: 12px 16px; }
            .main-header h1 { display: none; }
            .main-content { flex-direction: column; }
            .chat-wrapper, .video-wrapper { border-right: none; flex: 1; }
            .video-wrapper { padding: 16px; }
            .video-wrapper.mobile-hidden, .chat-wrapper.mobile-hidden { display: none; }
            .mobile-nav { display: flex; flex-grow: 1; }
            .mobile-nav-btn { flex: 1; background: transparent; border: none; color: var(--text-secondary); padding: 10px; cursor: pointer; font-size: 0.9rem; font-weight: 500; border-bottom: 2px solid transparent; transition: all 0.2s ease; }
            .mobile-nav-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="main-header">
            <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Back</button>
            <h1>Chat & Share</h1>
            <nav class="mobile-nav">
                <button id="showChatBtn" class="mobile-nav-btn active">üí¨ Chat</button>
                <button id="showVideosBtn" class="mobile-nav-btn">üìπ Videos</button>
            </nav>
        </header>

        <main class="main-content">
            <div class="chat-wrapper" id="chatWrapper">
                <iframe src="https://deadsimplechat.com/unCdUEWRr" class="chat-iframe"></iframe>
            </div>
            <div class="video-wrapper mobile-hidden" id="videoWrapper">
                <div class="upload-area" id="uploadArea">
                    <h3>Share a Video</h3>
                    <p>Drag and drop or click to select a file</p>
                    <input type="file" id="videoInput" class="file-input" accept="video/*">
                    <div style="margin-top: 16px;"><button class="btn" id="chooseVideoBtn">Choose File</button></div>
                </div>
                <div class="video-display" id="videoDisplay"></div>
            </div>
        </main>
    </div>

    <script>
        const chatWrapper = document.getElementById('chatWrapper');
        const videoWrapper = document.getElementById('videoWrapper');
        const showChatBtn = document.getElementById('showChatBtn');
        const showVideosBtn = document.getElementById('showVideosBtn');
        const uploadArea = document.getElementById('uploadArea');
        const videoInput = document.getElementById('videoInput');
        const chooseVideoBtn = document.getElementById('chooseVideoBtn');
        const videoDisplay = document.getElementById('videoDisplay');

        showChatBtn.addEventListener('click', showChatView);
        showVideosBtn.addEventListener('click', showVideosView);

        function showChatView() {
            chatWrapper.classList.remove('mobile-hidden');
            videoWrapper.classList.add('mobile-hidden');
            showChatBtn.classList.add('active');
            showVideosBtn.classList.remove('active');
        }

        function showVideosView() {
            chatWrapper.classList.add('mobile-hidden');
            videoWrapper.classList.remove('mobile-hidden');
            showChatBtn.classList.remove('active');
            showVideosBtn.classList.add('active');
            fetchVideos(); // Fetch videos when the video tab is shown
        }

        // --- Video Upload Logic ---
        chooseVideoBtn.addEventListener('click', () => {
            videoInput.click();
        });

        videoInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('video', file);

            try {
                const response = await fetch('/api/upload-video', {
                    method: 'POST',
                    body: formData,
                });
                const data = await response.json();
                if (data.success) {
                    console.log('Upload successful:', data.video);
                    // Video will be added via WebSocket broadcast
                } else {
                    console.error('Upload failed:', data.error);
                    alert('Video upload failed: ' + data.error);
                }
            } catch (error) {
                console.error('Error during upload:', error);
                alert('An error occurred during video upload.');
            }
            videoInput.value = ''; // Clear the input
        });

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (event) => {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                videoInput.files = files;
                videoInput.dispatchEvent(new Event('change'));
            }
        });

        // --- Video Display Logic ---
        async function fetchVideos() {
            try {
                const response = await fetch('/api/videos');
                const videos = await response.json();
                videoDisplay.innerHTML = ''; // Clear current videos
                videos.forEach(addVideoToDisplay);
            } catch (error) {
                console.error('Error fetching videos:', error);
                videoDisplay.innerHTML = '<p style="color: var(--danger-color);">Failed to load videos.</p>';
            }
        }

        function addVideoToDisplay(video) {
            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.dataset.videoId = video.id; // Store Cloudinary public_id

            const videoElement = document.createElement('video');
            videoElement.controls = true;
            videoElement.src = video.url;
            videoElement.alt = video.name;
            videoElement.preload = 'metadata'; // Load metadata to show first frame

            const videoInfo = document.createElement('div');
            videoInfo.className = 'video-info';

            const videoName = document.createElement('div');
            videoName.className = 'video-name';
            videoName.textContent = video.name;

            const videoTime = document.createElement('div');
            videoTime.className = 'video-time';
            videoTime.textContent = new Date(video.timestamp).toLocaleString();

            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-video-btn';
            deleteButton.innerHTML = '&times;'; // 'x' icon
            deleteButton.title = 'Delete Video';
            deleteButton.addEventListener('click', () => deleteVideo(video.id));

            videoInfo.appendChild(videoName);
            videoInfo.appendChild(videoTime);
            videoItem.appendChild(videoElement);
            videoItem.appendChild(videoInfo);
            videoItem.appendChild(deleteButton);
            videoDisplay.prepend(videoItem); // Add new videos to the top
        }

        async function deleteVideo(videoId) {
            if (!confirm('Are you sure you want to delete this video?')) {
                return;
            }
            try {
                const response = await fetch(`/api/videos/${videoId}`, {
                    method: 'DELETE',
                });
                const data = await response.json();
                if (data.success) {
                    console.log('Video deleted:', videoId);
                    // Video will be removed via WebSocket broadcast
                } else {
                    console.error('Delete failed:', data.error);
                    alert('Video deletion failed: ' + data.error);
                }
            } catch (error) {
                console.error('Error during delete:', error);
                alert('An error occurred during video deletion.');
            }
        }

        // --- WebSocket Client ---
        const ws = new WebSocket('ws://localhost:3000'); // Adjust if your server is on a different port/host

        ws.onopen = () => {
            console.log('WebSocket connected');
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'new_video') {
                addVideoToDisplay(message.video);
            } else if (message.type === 'video_deleted') {
                const videoItem = document.querySelector(`[data-video-id="${message.videoId}"]`);
                if (videoItem) {
                    videoItem.remove();
                }
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected');
        };

        // Initial fetch of videos when the page loads (if video tab is active by default or on first view)
        // This will be called when showVideosView is called.
        // fetchVideos();
    </script>
</body>
</html>